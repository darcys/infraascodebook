# 动态基础设施的挑战
在这一节，我们一起来运维团队在实施动态基础设施和自动配置工具时经常会碰到的一些问题。这些是基础设施即代码会解决的问题，所以理解他们是理解接下来的基础设施即代码的原理和概念的基础。

## 配置漂移
服务器刚创建出来的时候可能都是一致的，但是随着时间的推移，变化就悄悄的混进来了。
可能有人在Oracle服务器上修补了一个特定用户的问题，所以这台机器和其他Oracle服务器的配置就不一样了。新版本的JIRA需要新版本的JDK，于是这台JIRA服务器和其他装有java的服务器就有差异。三个人在三台不同的机器上安装IIS，每个人的把它配置的都不一样。一台JBOSS服务器比其他几台JBOSS的网络流量更高并且变得不太稳定，于是有人上去调整它，所以它的配置会和别的JBOSS不一样。

有区别并不是坏事。那台负载比较重的JBoss服务器可能需要调整的与其他低负载的机器不同。但是这些变化应该被记录并管理，并且可以方便的重新创建出这样的机器。

服务器之间没被管理的变化导致了雪花服务器和自动化恐惧。

## 雪花服务器
> Darcy注释： 雪花服务器的出处是[马丁福勒大神的博客](http://martinfowler.com/bliki/SnowflakeServer.html), 没接触过这个概念的最好先读一下这篇博客。
多年以前，我在一家公司做web应用，这些应用是Perl CGI的巨大合集。（不用批判我们，那是dot-com时代，每个人都这么做。）我们最开始使用Perl 5.6开始，后来升级到Perl 5.8。并且不能在Perl 5.6上使用。最终几乎所有更新的应用服务器都使用5.8，但是有一个特别的并且重要的应用，不能简单的在5.8上run。
真实的情况比这个更糟糕，应用程序在已经升级到5.8共享的staging环境上运行是好的，但是在真正的staging环境上却不行。不要问为什么我们没有在测试环境发现这个问题而直接把产品线升级到了Perl 5.8，我们没有深究下去。 我们有个特别的server可以在Perl 5.8上运行这个程序，但是所有其他服务器都不行。
我们就这么令人羞愧的运行了很长的时间，在staging的服务器运行Perl 5.6很长时间，并且祈祷线上环境不会出问题。我们惧怕触碰产品线的任何配置，担心会干扰了什么让这台机器能运行的魔法。
这个情况导致我们发现了[infrastructures.org](http://www.infrastructures.org)，这个网站给予我的一些主意正是基础设施即代码的先驱。
我们确认我们所有的服务器是通过可重复的方式来创建的，使用FAI来做PXE启动的安装，Cfengine来配置服务器，并且所有的东西都checkin到CVS
很多IT的运维部门都有类似的故事，某些服务器不能触碰，并且无法重新复制出这个服务器。这并不是永远的不可思议的脆弱；有时一个重要的软件包运行在一个完全不同的操作系统上。在我记忆里，一个会计的软件包需要在AIX系统上运行，然后一个PBX系统是运行在Windows NT 3.51服务器上，并且是一个已经离职很久的合同工安装的。
再一次重申，变得不同并不是坏事。问题是当团队不理解为什么这些server会不同并且有哪些差异，所以就不能重建构造一个这样的机器。 一个IT运维部门应该有信心并且快速的重新创建出他们维护的任意一台机器。如果任何server不能满足这样的需求，那么构建一个新的，可重现的流程，从而可以取代有问题的server，应该是当务之急。

## Jenga（叠叠乐）基础设施
一个Jenga基础设施容易被破坏，并且不容易被修复。这是雪花服务器的升级版。
解决方案是把基础设施里的所有东西都迁移到一个可靠的，可再制的基础设施上，“The Visible Ops Handbook'这本书描述了将稳定性和可预测性引入一个问题重重的基础设施。

> 有个值得怀疑的故事，一个数据中心里有一台服务器，没人有登陆的权限，也没人确定那个服务器是做什么的。有人把服务器放倒并拔掉网线。系统网络服务彻底失效，后来网线重新被插上，然后再也没人碰那台服务器。

## 自动化恐惧
在DevOpsDay大会的一次关于配置管理的分享会议上，我问组里有多少在用类似Puppet或者Chef的自动化工具。大部分都举手，我又问有多少次是在没人关注，自动安排运行的。大部分的人手又放了下去。
很多人有和我早年使用自动化工具相同的问题。我有选择的使用自动化工具，比如去创建一个新的服务器，或者去做一个特别的配置改变。我每次都小心调整配置从而适合某个特定的任务之后再运行它。
我不敢把视线离开自动化工具，让它自动运行，因为我缺乏信心。
我缺乏信心是因为服务器变得不一致。
服务器变得不一致是因为我没有频繁和一致的运行自动化工具。

### 自动化恐惧旋涡
* 在自动化工具外进行变更
* 服务器变得不一致
* 担心运行自动化工具会搞坏什么
这就是自动化恐惧的旋涡，基础设施部分需要通过成功的使用自动化来打破这个旋涡。
打破这个旋涡最有效的方式就是面对这个恐惧。挑几台机器，调整配置定义从而让他可运行，然后安排在没人关注的情况下，最少每小时运行一次。然后再挑另外几台机器，重复这个过程，直到所有的机器都可以持续的被更新。

早上好，第三章提到的自动化测试，会帮助树立起对配置管理工具的信心，并且能更早的发现问题。

## 腐蚀
在理想的世界里，当自动化的基础设施创建完毕，除了支持一些新功能或者修复一些问题，我们永远不需要去管他。可悲的是，混沌的力量意味着哪怕没有新需求，我们的基础设施还是会随着时间衰败。 Heroku的同事称之为腐蚀，腐蚀的意思是问题会悄悄的渗入到一个运行的系统里。

关于系统随着时间而被腐蚀，Heroku的同事给出以下的例子：









